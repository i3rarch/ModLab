name: Build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.0'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        modules: 'qtserialport'
        cache: true
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Build
      run: |
        msbuild diplom_v0.sln /p:Configuration=Release /p:Platform=x64 /m
    
    - name: Deploy Qt Dependencies
      run: |
        windeployqt --release --no-translations x64/Release/diplom_v0.exe
    
    - name: Package
      run: |
        Compress-Archive -Path x64/Release/* -DestinationPath ModLab-Windows-x64.zip
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ModLab-Windows-x64
        path: ModLab-Windows-x64.zip
        retention-days: 90

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.0'
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        modules: 'qtserialport'
        cache: true
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxcb-cursor0 libgl1-mesa-dev
    
    - name: Create CMakeLists.txt
      run: |
        cat > CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.16)
        project(diplom_v0 VERSION 1.0 LANGUAGES CXX)

        set(CMAKE_CXX_STANDARD 17)
        set(CMAKE_CXX_STANDARD_REQUIRED ON)
        set(CMAKE_AUTOMOC ON)
        set(CMAKE_AUTOUIC ON)
        set(CMAKE_AUTORCC ON)

        find_package(Qt6 REQUIRED COMPONENTS Core Widgets SerialPort)

        add_executable(${PROJECT_NAME}
            diplom_v0/main.cpp
            diplom_v0/diplom_v0.cpp
            diplom_v0/diplom_v0.h
            diplom_v0/diplom_v0.ui
            diplom_v0/diplom_v0.qrc
        )

        target_link_libraries(${PROJECT_NAME} PRIVATE
            Qt6::Core Qt6::Widgets Qt6::SerialPort
        )
        EOF
    
    - name: Build
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        cmake --build . -j$(nproc)
    
    - name: Package
      run: |
        mkdir -p ModLab-Linux-x64
        cp build/diplom_v0 ModLab-Linux-x64/
        chmod +x ModLab-Linux-x64/diplom_v0
        
        # Create run script
        cat > ModLab-Linux-x64/run.sh << 'EOF'
        #!/bin/bash
        DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"
        "$DIR/diplom_v0" "$@"
        EOF
        chmod +x ModLab-Linux-x64/run.sh
        
        # Copy Qt libraries
        mkdir -p ModLab-Linux-x64/lib
        ldd build/diplom_v0 | grep Qt | awk '{print $3}' | xargs -I {} cp {} ModLab-Linux-x64/lib/ || true
        
        tar -czf ModLab-Linux-x64.tar.gz ModLab-Linux-x64/
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ModLab-Linux-x64
        path: ModLab-Linux-x64.tar.gz
        retention-days: 90

  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download Windows Build
      uses: actions/download-artifact@v4
      with:
        name: ModLab-Windows-x64
    
    - name: Download Linux Build
      uses: actions/download-artifact@v4
      with:
        name: ModLab-Linux-x64
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ModLab-Windows-x64.zip
          ModLab-Linux-x64.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
